# 【NOIP2013模拟联考8】匹配(match) 题解

- [ac 自动机](https://oi-wiki.org/string/ac-automaton/)
- [ac 自动机上 dp](https://oi-wiki.org/string/ac-automaton/#ac-自动机上-dp)
- `f[i][s][j]` 母串长度i，匹配情况s，ac自动机节点j

---

先想一个弱化版问题：给定 $k$ 个模式串以及长度为 $n$ 的母串可选字母的集合，对于一个母串，它的价值为**出现模式串的个数**。问所有合法母串的价值和。

怎么才能判定一个母串是否包含几个模式串？

我们可以想到 ac 自动机，考虑对模式串建 ac 自动机，定义 `tail` 为以一个节点为模式串结尾的**个数**。如果我们跑到了一个标记为 `tail` 的节点，说明我们的母串包含了这一个模式串。

模仿 ac 自动机的过程，用 $f[i][j]$ 表示母串长度为 $i$，走到了自动机上的节点 $j$ 的价值和，然后枚举它的下一个字符 $c$，明显有 $f[i+1][son[j][c]]\gets f[i][j] + tail[son[j][c]]$。

---

回到原问题，因为我们要求完整出现给定的 $k$ 个模式串的方案数，所以我们状压模式串的出现情况为 $s$。

然后定义 `tail` 为以一个节点为模式串结尾的**状压出现情况**。

同时，我们在 ac 自动机中有一个跳 `fail` 的步骤，这个步骤不是线性的，因为我们此时已经状压了，就可以直接在建树时把它传给子节点，有 $tail[u]|=tail[fail[u]]$。

所以我们设 $f[i][s][j]$ 表示我们母串的长度为 $i$，模式串的匹配状态为 $s$（状压后），当前母串跑到了 ac 自动机的节点 $j$ 的方案数。

明显有 $f[i+1][s|tail[son[j][c]]][son[j][c]]\gets f[i][s][j]$。

$\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \href{https://www.cnblogs.com/znpdco/p/18071684}{\textcolor{white}{emm}}$